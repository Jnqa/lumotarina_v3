const express = require('express');
const fs = require('fs');
const path = require('path');
const { calculateCharacter } = require('../services/characterCalculator.js');

const router = express.Router();
const dataPath = path.resolve('characters/character_story.json');

router.get('/questions', (req, res) => {
  const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
  res.json(data.questions);
});

router.post('/submit', (req, res) => {
  const { answers } = req.body;
  const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));

  const result = calculateCharacter(data.questions, answers);

  // 2. Обрабатываем данные для второго результата
  const BackgroundStory = generateBackgroundStory(answers)

  // Отправляем оба результата в одном объекте
  res.json({
    character: result,
    backgroundStory: BackgroundStory
  });
});

function generateBackgroundStory(answers) {
  let intro = '';

  // 2. Хелпер для получения ID (для логики switch и if)
  // const findId = (id) => answers.find(a => a.questionId === id)?.optionId || '';
  const findId = (id) => answers[id] || ''; 

  // Извлекаем данные
  const genderId = findId('gender');
  const raceId = findId('race');
  const cityId = findId('birth_city');
  
  // Карта названий городов
  const cityNames = {
    'white_crown': 'в Белом Кроне',
    'kivigrad': 'в Кивиграде',
    'tarina': 'на острове Тарина',
    'kutarinovsk': 'в Кутариновске',
    'laululahthi': 'в посёлке Лаулулахти',
    'liymola': 'в Лиймоле',
    'luborg': 'в великом городе под названием Люборг',
    'mezhozerec': 'в Межозёрце',
    'mustalma': 'в не такой уж и мрачной Мустальме',
    'nesaual': 'в городе из далёких земель под названием Несауаль',
    'velemor': 'на островах Велемора',
    'saurkelm': 'в Сауркельме',
    'sosnovo': 'в городе дровосеков - Сосново',
    'suograd': 'в Суограде',
    'taivel': 'в Тайвеле',
    'tarina': 'в (Где?)',
    'tihoborie': 'в Тихоборье'
  };
  // Получаем красивое название. Если города нет в списке, используем ID как запасной вариант.
  const city = cityNames[cityId] || cityId;

  // 1. Обработка РАСЫ через switch
  switch (raceId) {
    case 'human':
      if (cityId !== 'tarina') {
        intro = genderId === 'male' ? `Ты человек, чей жизненный путь начался ${city}. ` : `Ты девушка, чей жизненный путь начался в городе ${city}. `;
        intro += "Мастер расскажет, что случилось немного ранее, но вся остальная история будет расказана тобой.";
        break;
      } if (cityId !== 'noktarina') {
          const g = (m, f) => genderId === 'male' ? m : f;
          intro = `Твой путь начался в Ноктарине. Ты давно странствуешь в поисках кого-то, ночуешь в тавернах и портах, где запах еды смешан с усталыми разговорами. В этот раз ${g('остановился', 'остановилась')} в портовом торговом городке — ночь обещала быть обычной.

Таверна казалась надёжной. Ты ${g('заказал', 'заказала')} купальню, ${g('переоделся', 'переоделась')} в халат, чувствуя, как усталость покидает тело. Всё шло спокойно до того момента, когда в небо ударил гром. Молния рассекла тьму, здание содрогнулось. Лёгкое подозрительное затишье, будто это не конец, затем нарастающий звук как будто разбивание стекла в реверсе, а затем с оглушительным взрывом тебя буквально вынесло из здания вместе с окном и стеной раздробленной на щепки.

Ты видишь как отдаляешься от горящего особняка и летишь вниз с обрыва. Резкое погружение в воду. Темнота.

Ты ${g('очнулся', 'очнулась')} в каюте на маленьком рыбацком судне. В нос ударил резкий запах рыбы и смолы, тело ломило, силы едва возвращались, в глазах было мутно. Лежа на полу, ты заметил силуэт за столом. Мужчина невысокого роста, плечи слегка согнуты, лицо в тени, тихо закашлялся, а потом хрипло сказал:

— «Ого… с пробуждением, значит… Чудо, что ты ${g('выжил', 'выжила')} после такого падения… Стой-стой-стой, не пытайся говорить, просто лежи. Скажу только одно: старушка моя, она когда-то врачевала, разобралась, что с тобой делать».

Ты ${g('почувствовал', 'почувствовала')}, как усталость давит, и даже произнести слово не ${g('мог', 'могла')}.

Через час ты снова ${g('проснулся', 'проснулась')} — от грубых криков и металлических ударов. Пожилая женщина вошла в каюту, с мягким взглядом и морщинами на лице, тихо подошла с фонарём в руке:

— «Ну вот, ${g('очнулся', 'очнулась')}, наконец… Старый там..», — крик с улицы её перебил. — «..да грёбаный карась!».

Старушка мило улыбнулась и продолжила:

— «Старый там за стенкой шумит, движок накрылся, но он его починит... всегда чинил..  и скоро мы уже доберёмся до Мустальмы».

— «Мустальмы?» — с трудом ${g('выдавил', 'выдавила')} ты, а старушка с удивлением ответила:

— «Да ничего особенного… город, где хоть какая-то медицина есть. Ты первый раз слышишь это название? Хотя, после такой травмы.. ох ${g('бедный', 'бедная')}.», — старушка взгрустнула, и в её взгляде мелькнула забота, почти материнская.

Внезапно что-то загудело, затарахтело, появился свет и ты впервые ${g('огляделся', 'огляделась')}: вокруг были простые рыбацкие приборы, верёвки и.. фонари, они выгядели иначе, да и всё вокруг какое-то не как на тех судах, знакомых тебе. 

А ещё на стене висела карта и эти края явно были не похожи на те, где ты ${g('бывал', 'бывала')} ранее.

Ты ${g('почувствовал', 'почувствовала')}: мир вокруг незнаком. Кроме твоей промокшей сумки с вещами, что лежала рядом с кроватью и... Ох, чёрт! Ты лежишь под пледом в халате, а твоя одежда.. да кто ж теперь знает что с ней.

Старушка обернулась и сказала:

— «А может Тайвель?» — ты не ${g('понял', 'поняла')} о чём она и не успев отвеить, старая продолжила говорить странные слова: — «Сауркельм? Белый Крон?», но уловив твой непонимающий взгяд, она с грустно улыбнулась и ушла.

(Что было дальше?)

///  Игрок, Ты слаб, лишён почти всех сил, но жив. Мир вокруг незнаком, и твоя история только начинается. Дальше тебе предстоит выбрать свой путь и класс, а пока перед тобой открывается новый мир.`
        break;
      }  else {
        const greeting = genderId === 'male' ? 'парень' : 'подруга';
        intro = `Привет, ${greeting}, жизнь конечно тебя помотала, и твоё прошлое окутано тайной даже для тебя. `;
        intro += "В процессе истории мы сможем понять, что произошло и откуда ты.";
        break;
      }

    case 'mait': {
      const greeting = genderId === 'male' ? 'мужик' : 'маленькая красавица';
      intro = `Привет, ${greeting}! Твой путь начался ${city}. Мастер расскажет, что случилось немного ранее, но вся остальная история будет расказана тобой. `;
      break;
    }
    
    case 'shadowblood': {
      // Хелпер: первое слово для м.р., второе для ж.р.
      const g = (m, f) => genderId === 'male' ? m : f;
      intro = `Привет, ${g('мрачный тип', 'мрачная девушка')}! Твой путь начался в Ноктарине. Сейчас ты узнаешь, что случилось пару лет назад, но вся более ранняя история будет рассказана тобой. 
      
Поздним вечером ты решаешь отправиться в город. Рынок уже почти закрывался, но именно в это время там можно было решить дела без лишних глаз и вопросов. Ночь обещала быть спокойной, обычной, из тех, что не запоминаются.

Таверна, где пришлось остановиться, выглядела надёжно. Тёплый свет, запах еды, усталые разговоры. Всё шло как надо ровно до момента, когда в небо ударил гром. Молния рассекла темноту и в следующую секунду здание содрогнулось. Огонь вспыхнул сразу, жадно, будто ждал сигнала. Дым заполнил помещение, крики смешались с треском горящих балок.

Ты, пытаясь выбраться, двигаешься на ощупь, через жар и кашель, теряя ориентацию с каждым шагом. В какой-то момент дверь всё же поддалась, и удалось вырваться наружу.

Только это была уже не таверна и не город.

В одиночестве среди тёмного леса горел особняк. Высокий, чужой, без следов жизни вокруг. Ни голосов, ни дороги назад, ни признаков того места, откуда всё началось. Лишь огонь, ночь и ощущение ошибки, которую невозможно объяснить словами.

Оставаться было бессмысленно. Не разбирая дороги, ты уходишь в лесную темноту, прочь от огня, в поисках хоть каких-то ответов.

Часы тянулись медленно. Лес редел, под ногами появилась вязкая почва, воздух стал тяжёлым и сырым. К ночи впереди показались несколько покосившихся домов, стоящих прямо посреди болота. В одном из них горел свет.

Ты подходишь ближе и входишь внутрь.

За столом сидели старик и старуха. Увидев тебя, они замерли, а затем закричали. Свет лампы выхватил твою обесцвеченную кожу, и страх мгновенно сменился яростью. Старик схватил кочергу, старуха — тяжёлую палку. Они кричали, замахивались, гнали тебя к выходу, называя болотной тварью и серой падалью, будто ты ${g('был', 'была')} не живым существом, а чем-то, что нужно изгнать и уничтожить.

Ты не ${g('стал', 'стала')} отвечать. Развернувшись, ты ${g('вырвался', 'вырвалась')} наружу и ${g('бросился', 'бросилась')} бежать, проваливаясь в грязь, скользя, не останавливаясь, пока крики не исчезли в тумане.

Болото тянулось бесконечно. Лишь к утру впереди показались каменные стены и высокие здания. Крупный город встречал шумом и движением. По дорогам с грохотом проносились странные металлические коробки, которых ты никогда раньше не ${g('видел', 'виделa')}. Они двигались сами, оставляя за собой запах и рев.

С первыми лучами солнца кожа начала жечь. Боль нарастала быстро и нестерпимо. Ты ныряешь в узкий переулок, прижимаясь к холодному камню, пытаясь скрыться от света.

Но.. внезапное плохое предчувствие, будто-то ты в опасности.

В этот момент одна из металлических коробок остановилась рядом. Вспыхнули яркие огни. Из неё вышли двое людей в одинаковой форме. Их голоса были грубыми и резкими. Они приказывали не двигаться, шагая в твою сторону угрожающе и похлопывая дубинками по руке.

Паника взяла верх.

Ты проламываешь ближайшее окно, падаешь в тёмный подвал и, не оглядываясь, исчезаешь в глубине города, оставляя за собой шум, стекло и ещё одно место, где тебе не нашлось места.

(Что было дальше?) 

// Игрок, твой выбор пал на расу Темнокровых, на следующем можешь выбрать любой понравившийся класс, но рекомендуемый класс лучше соответствует твоей предыстории`;

      break;
    }

    case 'regalif': {
      const greeting = genderId === 'male' ? 'красавец' : 'Регалифка';
      intro = `Привет, ${greeting}! Твой путь начался в Ноктарине. Сейчас ты узнаешь, что случилось пару лет назад, но вся более ранняя история будет рассказана тобой. `;
      intro += `Поздним вечером ты решаешь отправиться в город. Рынок уже почти закрывался, но именно в это время там можно было решить дела без лишних глаз и вопросов. Ночь обещала быть спокойной, обычной, из тех, что не запоминаются.

Таверна, где пришлось остановиться, выглядела надёжно. Тёплый свет, запах еды, усталые разговоры. Всё шло как надо ровно до момента, когда в небо ударил гром. Молния рассекла темноту и в следующую секунду здание содрогнулось. Огонь вспыхнул сразу, жадно, будто ждал сигнала. Дым заполнил помещение, крики смешались с треском горящих балок.

Ты, пытаясь выбраться, двигаешься на ощупь, через жар и кашель, теряя ориентацию с каждым шагом. В какой-то момент дверь всё же поддалась, и удалось вырваться наружу.

Только это была уже не таверна и не город.

В одиночестве среди тёмного леса, горел особняк. Высокий, чужой, без следов жизни вокруг. Ни голосов, ни дороги назад, ни признаков того места, откуда всё началось. Лишь огонь, ночь и ощущение, что что-то пошло не так на уровне, который нельзя объяснить.

Оставаться было бессмысленно. От особняка вела единственная дорога. Ты отправляешься на неё, не имея других вариантов.

Через долгие часы путь вывел к мрачному портовому городу. Город стоял на месте, живой и привычный, словно ничего не произошло. Но с этого момента стало ясно: назад уже не вернуться, а случайный вечер на рынке оказался началом совсем другой истории.

(Что было дальше?) 

// Игрок, так как твой выбор пал на рассу Регалиф, то на следующем шаге рекомендую выбрать класс Регалиф. Чтобы сохранить осбобые способности класса, но выбор всегда за тобой.`;

      break;
    }

    case 'animalic': {
      const g = (m, f) => genderId === 'male' ? m : f;
      intro = `Привет, ${g('пушистый или же ты ящер какой, а может весь в перьях?', 'пушистая или же ты ящерка какая, а может вся в перьях?')} Твой путь начался в Ноктарине. Сейчас ты узнаешь, что случилось пару лет назад, но вся более ранняя история будет рассказана тобой. `;
      intro += `Поздним вечером ты решаешь отправиться в город. Рынок уже почти закрывался, но именно в это время там можно было решить дела без лишних глаз и вопросов. Ночь обещала быть спокойной, обычной, из тех, что не запоминаются.

Таверна, где пришлось остановиться, выглядела надёжно. Тёплый свет, запах еды, усталые разговоры. Всё шло как надо ровно до момента, когда в небо ударил гром. Молния рассекла темноту и в следующую секунду здание содрогнулось. Огонь вспыхнул сразу, жадно, будто ждал сигнала. Дым заполнил помещение, крики смешались с треском горящих балок.

Ты, пытаясь выбраться, двигаешься на ощупь, через жар и кашель, теряя ориентацию с каждым шагом. В какой-то момент дверь всё же поддалась, и удалось вырваться наружу.

Только это была уже не таверна и не город.

В одиночестве среди тёмного леса горел особняк. Высокий, чужой, без следов жизни вокруг. Ни голосов, ни дороги назад, ни признаков того места, откуда всё началось. Лишь огонь, ночь и ощущение ошибки, которую невозможно объяснить словами.

От особняка тянулась дорога, заваленная поваленными соснами. Ты смотришь на неё недолго и решаешь углубиться в лес, свернув на узкую тропу. Она вела между деревьев уверенно, будто кто-то регулярно по ней ходил. Через некоторое время впереди показался небольшой домик лесника. В окнах горел свет.

Ты вежливо стучишь в дверь.

Дверь открывает широкий, бородатый старик с топором в руке. Увидев тебя, он замирает на секунду, затем выдыхает:
— Ну ёп твою ж ёлочку…

Он медленно осматривает тебя с ног до головы, после чего откладывает топор в сторону, делает шаг назад и, махнув рукой в сторону кухни, говорит:
— Проходи и рассказывай, что ж ты за зверь такой.

Ты проходишь на кухню, но не успеваешь ничего сказать. Старик закрывает дверь, оборачивается и бурчит:
— Ты тоже из этого грёбаного особняка? Да чтоб он сгорел.

— Дак он сгорел, — отвечаешь ты.

Старик усмехается:
— Ну… главное, чтоб лес не задело.

Он с грохотом ставит на стол чашку с горячим чаем и продолжает:
— Раз сгорел, значит, гостей у меня тут больше не будет. Даже как-то грустно. А ведь несколько дней назад нашёл одного путешественника под сосной, еле живого. Отвёз его в город. Он решил, что ему на Тарину надо. Пф. Билет в один конец.

Ты вздрагиваешь, услышав знакомое название:
— Тарина?

Старик прищуривается:
— Только не говори, что ты оттуда. Хотя без разницы. Корабль уже уплыл и вряд ли вернётся.

Эти слова давят сильнее, чем хотелось бы. На кухне повисает неловкое молчание.

— Слушай, — наконец говорит старик, — помочь я тебе вряд ли смогу. После последней поездки тачка накрылась, так что до города не подвезу.

Ты машинально представляешь телегу и удивляешься, зачем вообще возить кого-то на такой развалюхе. Старик, не заметив этого, продолжает:
— В нашем мире таких чучел не водится. Так что совет простой: прячь лицо. Иначе даже я не берусь гадать, что с тобой сделают.

Вы сидите до поздней ночи. Он рассказывает про эти края, про лес, болота и людей. Ты рассказываешь, откуда пришёл и что знаешь о своём мире. Без криков, без страха. Просто душевный разговор.

Ранним утром ты обматываешься тряпками, прощаешься и выходишь на тропу. Впереди путь, в котором пока больше вопросов, чем ответов, но хотя бы один дом в этом мире оказался не враждебным.

(Что было дальше?) 

// Игрок, так как твой выбор пал на рассу Звероликих, то рекомендую быть осторожным в этом мире приключений, там откуда ты, такие как ты это нормально, но тут ты вызовешь явный интерес у людей. 
 
Осторожно выбирай тех, кому можешь доверится и удачной игры! И будь ${g('добр', 'любезна')}, кинь сейчас кубик d20, это порадует мастера.`;

      break;
    }

    default: { intro = "Ваше происхождение окутано тайной. Это вообще как?"; }
  }
  
  return intro;
}

module.exports = router;
